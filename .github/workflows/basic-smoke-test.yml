name: Basic smoke test

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-test:
    if: github.actor != 'github-actions[bot]'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10"]
    defaults:
      run:
        shell: bash
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build svVascularize
        run: |
          pip install .

      - name: Run basic smoke test
        run: |
          python - << 'PY'
          import pyvista as pv
          from svv.domain.domain import Domain
          from svv.tree.tree import Tree
          from svv.simulation.simulation import Simulation

          cube = Domain(pv.Cube())
          cube.create()
          cube.solve()
          cube.build()

          t = Tree()
          t.set_domain(cube)
          t.set_root()
          t.n_add(10)

          sim = Simulation(t)
          sim.build_meshes(fluid=True, tissue=True, boundary_layer=False)
          PY

      - name: Record job status
        if: always()
        run: |
          echo "${{ matrix.os }}=${{ job.status }}" > smoke-status.txt

      - name: Upload status artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-status-${{ matrix.os }}
          path: smoke-status.txt

  update-smoke-badge:
    if: github.actor != 'github-actions[bot]'
    needs: build-and-test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download status artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: smoke-status-*
          path: smoke-status
          merge-multiple: true

      - name: Update README smoke test badge
        run: |
          set -euo pipefail

          linux="unknown"
          macos="unknown"
          windows="unknown"

          # Each artifact directory contains a single smoke-status.txt file.
          for f in smoke-status/*/*; do
            line=$(cat "$f")
            os="${line%%=*}"
            status="${line#*=}"

            result="fail"
            if [ "$status" = "success" ]; then
              result="ok"
            fi

            case "$os" in
              ubuntu-latest) linux="$result" ;;
              macos-latest) macos="$result" ;;
              windows-latest) windows="$result" ;;
            esac
          done

          label="linux_${linux}-macos_${macos}-windows_${windows}"

          if [ "$linux" = "ok" ] && [ "$macos" = "ok" ] && [ "$windows" = "ok" ]; then
            color="brightgreen"
          elif [ "$linux" = "fail" ] || [ "$macos" = "fail" ] || [ "$windows" = "fail" ]; then
            color="red"
          else
            color="lightgrey"
          fi

          badge_url="https://img.shields.io/badge/svv_smoke-${label}-${color}"
          link="https://github.com/${GITHUB_REPOSITORY}/actions/workflows/basic-smoke-test.yml?query=branch%3A${GITHUB_REF_NAME}"
          new_badge="[![SVV smoke test](${badge_url})](${link})"

          perl -0pi -e "s/<!-- smoke-test-badge -->.*?<!-- \\/smoke-test-badge -->/<!-- smoke-test-badge -->${new_badge}<!-- \\/smoke-test-badge -->/s" README.md

      - name: Commit README badge update
        run: |
          if git diff --quiet README.md; then
            echo "No README changes to commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "Update smoke test status badge"
            git push
          fi

