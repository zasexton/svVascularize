<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>svv.simulation.Simulation - svVascularize API</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" />
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="style_api.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Shared top navigation -->
    <header class="topnav">
        <div class="container">
            <h1>svVascularize</h1>
            <nav>
                <a href="../index.html#about">About</a>
                <a href="../install.html">Installation</a>
                <a href="../doc.html">Documentation</a>
                <a href="../index.html#simulation">Simulation</a>
                <a href="https://pypi.org/project/svv/" target="_blank" rel="noopener">PyPI</a>
                <a href="https://github.com/SimVascular/svVascularize" target="_blank" rel="noopener">GitHub</a>
            </nav>
        </div>
    </header>

    <!-- Breadcrumbs -->
    <div class="container">
        <nav class="api-breadcrumbs">
            <a href="../doc.html">Documentation</a>
            <span class="separator">/</span>
            <a href="index_api.html">API Reference</a>
            <span class="separator">/</span>
            <a href="index_api.html#module-simulation">svv.simulation</a>
            <span class="separator">/</span>
            <span>Simulation</span>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="container api-container">
        <!-- Class Header -->
        <div class="api-class-header">
            <h1><code>svv.simulation.Simulation</code></h1>
            <div class="api-badges">
                <span class="api-module-badge">Simulation Class</span>
                <span class="api-version-badge">v1.0.0</span>
            </div>
        </div>

        <!-- Class Description -->
        <div class="api-class-description">
            <p>
                The Simulation class provides a comprehensive framework for generating physics simulation files
                from synthetic vascular networks. It handles mesh generation, boundary condition specification,
                and export of simulation-ready files for various solvers.
            </p>
            <!--
            <p>
                Supports multiple simulation types including 3D CFD, 1D reduced-order models, and 0D lumped
                parameter models for both fluid dynamics and tissue perfusion. The class manages the complete
                pipeline from geometric models to solver input files.
            </p>
            -->
        </div>

        <!-- Quick Example -->
        <div class="api-quick-example">
            <h2>Quick Example</h2>
            <pre data-copy><code class="language-python">from svv.simulation import Simulation
from svv.tree import Tree

# Create simulation from tree
sim = Simulation(tree, name="coronary_sim", directory="./simulations")

# Build meshes with boundary layers
sim.build_meshes(
    fluid=True,
    tissue=True,
    boundary_layer=True,
    layer_thickness_ratio=0.25,
    hausd=0.0001
)

# Extract faces for boundary conditions
sim.extract_faces(crease_angle=60.0)

# Construct 3D fluid simulation
sim.construct_3d_fluid_simulation()

# Write simulation files
sim.write_3d_fluid_simulation()

# Also prepare 1D simulation
sim.construct_1d_fluid_simulation(
    viscosity=0.004,
    density=1060,
    time_step_size=0.001,
    number_time_steps=1000
)</code></pre>
        </div>

        <!-- Main Documentation Grid -->
        <div class="api-grid">
            <!-- Left Navigation -->
            <aside class="api-sidebar">
                <div class="sidebar-section">
                    <h4 class="sidebar-title">Contents</h4>
                    <nav class="api-sidebar-nav">
                        <ul>
                            <li><a href="#constructor"><i class="fas fa-hammer"></i> Constructor</a></li>
                            <li><a href="#attributes"><i class="fas fa-database"></i> Attributes</a></li>
                            <li><a href="#mesh-methods"><i class="fas fa-cube"></i> Mesh Methods</a></li>
                            <li><a href="#simulation-3d"><i class="fas fa-cube"></i> 3D Simulations</a></li>
                            <li><a href="#simulation-1d"><i class="fas fa-wave-square"></i> 1D Simulations</a></li>
                            <li><a href="#simulation-0d"><i class="fas fa-circle"></i> 0D Simulations</a></li>
                            <li><a href="#examples"><i class="fas fa-code"></i> Examples</a></li>
                            <li><a href="#workflow"><i class="fas fa-project-diagram"></i> Workflow</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="api-main-content">
                <!-- Constructor Section -->
                <section id="constructor" class="api-section">
                    <h2>Constructor</h2>

                    <div class="api-signature">
                        <code>Simulation(synthetic_object, name=None, directory=None)</code>
                    </div>

                    <div class="api-parameters">
                        <h3>Parameters</h3>
                        <table class="api-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Type</th>
                                    <th>Default</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>synthetic_object</code></td>
                                    <td>Tree or Forest</td>
                                    <td>required</td>
                                    <td>Vascular network to simulate</td>
                                </tr>
                                <tr>
                                    <td><code>name</code></td>
                                    <td>str</td>
                                    <td>auto-generated</td>
                                    <td>Simulation name (uses UUID if not provided)</td>
                                </tr>
                                <tr>
                                    <td><code>directory</code></td>
                                    <td>str</td>
                                    <td>current directory</td>
                                    <td>Output directory for simulation files</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Attributes Section -->
                <section id="attributes" class="api-section">
                    <h2>Attributes</h2>

                    <h3>Core Attributes</h3>
                    <table class="api-table">
                        <thead>
                            <tr>
                                <th>Attribute</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>synthetic_object</code></td>
                                <td>Tree/Forest</td>
                                <td>The vascular structure being simulated</td>
                            </tr>
                            <tr>
                                <td><code>file_path</code></td>
                                <td>str</td>
                                <td>Full path to simulation directory</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>Mesh Storage</h3>
                    <table class="api-table">
                        <thead>
                            <tr>
                                <th>Attribute</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>fluid_domain_surface_meshes</code></td>
                                <td>list</td>
                                <td>Surface meshes for fluid domains</td>
                            </tr>
                            <tr>
                                <td><code>fluid_domain_volume_meshes</code></td>
                                <td>list</td>
                                <td>Tetrahedral meshes for fluid domains</td>
                            </tr>
                            <tr>
                                <td><code>tissue_domain_surface_meshes</code></td>
                                <td>list</td>
                                <td>Surface meshes for tissue domains</td>
                            </tr>
                            <tr>
                                <td><code>tissue_domain_volume_meshes</code></td>
                                <td>list</td>
                                <td>Tetrahedral meshes for tissue domains</td>
                            </tr>
                            <tr>
                                <td><code>fluid_domain_boundary_layers</code></td>
                                <td>list</td>
                                <td>Boundary layer meshes</td>
                            </tr>
                            <tr>
                                <td><code>fluid_domain_wall_layers</code></td>
                                <td>list</td>
                                <td>Wall layer meshes for FSI</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>Simulation Objects</h3>
                    <table class="api-table">
                        <thead>
                            <tr>
                                <th>Attribute</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>fluid_3d_simulations</code></td>
                                <td>list</td>
                                <td>3D CFD simulation configurations</td>
                            </tr>
                            <tr>
                                <td><code>fluid_1d_simulations</code></td>
                                <td>list</td>
                                <td>1D ROM simulation configurations</td>
                            </tr>
                            <tr>
                                <td><code>fluid_0d_simulations</code></td>
                                <td>list</td>
                                <td>0D lumped parameter models</td>
                            </tr>
                            <tr>
                                <td><code>tissue_simulations</code></td>
                                <td>list</td>
                                <td>Tissue perfusion simulations</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Mesh Methods Section -->
                <section id="mesh-methods" class="api-section">
                    <h2>Mesh Generation Methods</h2>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>build_meshes(fluid=True, tissue=False, hausd=0.0001, hsize=None, minratio=1.1,
                         mindihedral=10.0, order=1, remesh_vol=False, boundary_layer=True,
                         layer_thickness_ratio=0.25, layer_thickness_ratio_adjustment=0.5,
                         boundary_layer_attempts=5, wall_layers=False, wall_thickness=None,
                         upper_num_triangles=1000, lower_num_triangles=100)</code>
                        </div>
                        <p>Build tetrahedral meshes for fluid and/or tissue domains with optional boundary layers.</p>
                        <div class="api-method-params">
                            <h4>Key Parameters</h4>
                            <ul>
                                <li><code>fluid</code> (bool): Generate fluid domain mesh</li>
                                <li><code>tissue</code> (bool): Generate tissue domain mesh</li>
                                <li><code>hausd</code> (float): Hausdorff distance for remeshing</li>
                                <li><code>minratio</code> (float): Minimum radius-edge ratio for tetrahedra</li>
                                <li><code>mindihedral</code> (float): Minimum dihedral angle</li>
                                <li><code>boundary_layer</code> (bool): Add boundary layers for CFD</li>
                                <li><code>layer_thickness_ratio</code> (float): Boundary layer thickness relative to mesh size</li>
                                <li><code>wall_layers</code> (bool): Add wall layers for FSI</li>
                            </ul>
                            <h4>Notes</h4>
                            <p>Uses TetGen for tetrahedralization and MMG for remeshing. Boundary layers are critical
                            for accurate wall shear stress calculation in CFD simulations.</p>
                        </div>
                    </div>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>extract_faces(crease_angle=60.0, verbose=False)</code>
                        </div>
                        <p>Extract and classify mesh faces as walls, caps, or interfaces.</p>
                        <div class="api-method-params">
                            <h4>Parameters</h4>
                            <ul>
                                <li><code>crease_angle</code> (float): Angle threshold for face classification</li>
                                <li><code>verbose</code> (bool): Print extraction progress</li>
                            </ul>
                            <h4>Notes</h4>
                            <p>Automatically identifies inlet/outlet caps and wall surfaces based on geometry.</p>
                        </div>
                    </div>
                </section>

                <!-- 3D Simulation Methods -->
                <section id="simulation-3d" class="api-section">
                    <h2>3D Simulation Methods</h2>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>construct_3d_fluid_simulation(*args)</code>
                        </div>
                        <p>Construct a 3D CFD simulation configuration.</p>
                        <div class="api-method-params">
                            <h4>Usage</h4>
                            <ul>
                                <li><code>sim.construct_3d_fluid_simulation()</code> for single-tree cases</li>
                                <li><code>sim.construct_3d_fluid_simulation(network_id)</code> for a specific network</li>
                                <li><code>sim.construct_3d_fluid_simulation(network_id, tree_id)</code> for a specific tree</li>
                            </ul>
                            <h4>Creates</h4>
                            <p>XML configuration file compatible with the svFSI solver, including mesh definitions,
                            boundary conditions, and solver parameters.</p>
                        </div>
                    </div>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>write_3d_fluid_simulation(*args)</code>
                        </div>
                        <p>Write 3D simulation files to disk.</p>
                        <div class="api-method-params">
                            <h4>Usage</h4>
                            <ul>
                                <li><code>sim.write_3d_fluid_simulation()</code> for single-tree cases</li>
                                <li><code>sim.write_3d_fluid_simulation(network_id)</code> for a specific network</li>
                                <li><code>sim.write_3d_fluid_simulation(network_id, tree_id)</code> for a specific tree</li>
                            </ul>
                            <h4>Output Structure</h4>
                            <pre><code>simulation_name/
├── mesh/
│   ├── fluid_msh_0/
│   │   ├── fluid_msh_0.vtu
│   │   └── mesh-surfaces/
│   │       ├── wall_0.vtp
│   │       ├── cap_0.vtp
│   │       └── cap_1.vtp
│   └── ...
└── fluid_simulation_0-0.xml</code></pre>
                        </div>
                    </div>
                </section>

                <!-- 1D Simulation Methods -->
                <section id="simulation-1d" class="api-section">
                    <h2>1D Simulation Methods</h2>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>construct_1d_fluid_simulation(*args, viscosity=None,
                                                    density=None, time_step_size=0.01,
                                                    number_time_steps=100,
                                                    olufsen_material_exponent=2)</code>
                        </div>
                        <p>Construct a 1D reduced-order model simulation.</p>
                        <div class="api-method-params">
                            <h4>Usage</h4>
                            <ul>
                                <li><code>sim.construct_1d_fluid_simulation()</code> for a single tree</li>
                                <li><code>sim.construct_1d_fluid_simulation(network_id, tree_id)</code> for forests</li>
                            </ul>
                            <h4>Parameters</h4>
                            <ul>
                                <li><code>viscosity</code> (float): Dynamic viscosity (Pa·s)</li>
                                <li><code>density</code> (float): Blood density (kg/m³)</li>
                                <li><code>time_step_size</code> (float): Time step (s)</li>
                                <li><code>number_time_steps</code> (int): Total time steps</li>
                                <li><code>olufsen_material_exponent</code> (float): Material model parameter</li>
                            </ul>
                            <h4>Notes</h4>
                            <p>Uses centerlines from the vascular tree to generate 1D network model.</p>
                        </div>
                    </div>
                </section>

                <!-- 0D Simulation Methods -->
                <section id="simulation-0d" class="api-section">
                    <h2>0D Simulation Methods</h2>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>construct_0d_fluid_simulation(*args)</code>
                        </div>
                        <p>Construct a 0D lumped parameter model. (To be implemented)</p>
                    </div>

                    <div class="api-method">
                        <div class="api-method-signature">
                            <code>pulsatile_waveform(*args)</code>
                        </div>
                        <p>Generate pulsatile flow waveforms for inlet boundary conditions. (To be implemented)</p>
                    </div>
                </section>

                <!-- Examples Section -->
                <section id="examples" class="api-section">
                    <h2>Examples</h2>

                    <div class="api-example">
                        <h3>Complete 3D CFD Simulation Setup</h3>
                        <pre data-copy><code class="language-python">from svv.simulation import Simulation
from svv.tree import Tree
from svv.domain import Domain
import pyvista as pv

# Generate vascular tree
mesh = pv.read('coronary_region.stl')
domain = Domain(mesh)
domain.create()
domain.solve()
domain.build()

tree = Tree()
tree.set_domain(domain)
tree.set_root([0, 0, 0])
tree.n_add(50)

# Create simulation
sim = Simulation(tree, name="coronary_cfd", directory="./cfd_sims")

# Build high-quality mesh with boundary layers
sim.build_meshes(
    fluid=True,
    tissue=False,
    boundary_layer=True,
    layer_thickness_ratio=0.2,  # 20% of mesh size
    boundary_layer_attempts=5,   # Retry if failed
    minratio=1.2,                # Good quality tetrahedra
    mindihedral=15.0,            # Avoid slivers
    remesh_vol=True              # Optimize volume mesh
)

# Extract and classify faces
sim.extract_faces(crease_angle=60.0)

# Setup simulation
sim.construct_3d_fluid_simulation()

# Write files
sim.write_3d_fluid_simulation()

print(f"Simulation files written to: {sim.file_path}")
print(f"Fluid mesh cells: {sim.fluid_domain_volume_meshes[0].n_cells}")
print(f"Boundary layer cells: {sim.fluid_domain_boundary_layers[0].n_cells if sim.fluid_domain_boundary_layers[0] else 0}")</code></pre>
                    </div>

                    <div class="api-example">
                        <h3>Multi-Scale Simulation (3D + 1D)</h3>
                        <pre data-copy><code class="language-python"># Generate both 3D and 1D models from same tree
sim = Simulation(tree, name="multiscale")

# 3D for proximal vessels
sim.build_meshes(fluid=True)
sim.extract_faces()
sim.construct_3d_fluid_simulation()

# 1D for distal vessels
sim.construct_1d_fluid_simulation(
    viscosity=0.004,      # Pa·s
    density=1060,         # kg/m³
    time_step_size=0.001, # 1ms
    number_time_steps=1000,
    olufsen_material_exponent=2.0
)

# Write both simulations
sim.write_3d_fluid_simulation()
sim.write_1d_fluid_simulation()

# Access centerlines for coupling
centerlines = sim.fluid_1d_simulations[0][0]
print(f"1D model segments: {centerlines.n_cells}")</code></pre>
                    </div>
                    <!--
                    <div class="api-example">
                        <h3>Tissue Perfusion Simulation</h3>
                        <pre data-copy><code class="language-python"># Create coupled fluid-tissue simulation
sim = Simulation(tree, name="perfusion")

# Build both domains
sim.build_meshes(
    fluid=True,
    tissue=True,  # Enable tissue domain
    wall_layers=True,  # For FSI
    wall_thickness=0.1  # mm
)

# Extract interfaces
sim.extract_faces()

# Setup fluid simulation
sim.construct_3d_fluid_simulation()

# Setup tissue perfusion (when implemented)
# sim.construct_3d_tissue_perfusion_simulation()

# Check interface conformity
fluid_mesh = sim.fluid_domain_meshes[0]
tissue_mesh = sim.tissue_domain_meshes[0]
print(f"Fluid domain cells: {fluid_mesh.mesh.n_cells}")
print(f"Tissue domain cells: {tissue_mesh.mesh.n_cells}")
print(f"Shared boundary faces: {len(sim.tissue_domain_faces[0]['shared_boundaries'])}")</code></pre>
                    </div>
                    -->
                </section>

                <!-- Workflow Section -->
                <section id="workflow" class="api-section">
                    <h2>Typical Workflow</h2>

                    <div class="admonition info">
                        <p><strong>Standard Pipeline:</strong></p>
                        <ol>
                            <li>Create Simulation object from Tree/Forest</li>
                            <li>Build meshes with desired refinement and layers</li>
                            <li>Extract faces for boundary condition application</li>
                            <li>Construct simulation configuration</li>
                            <li>Write files to disk</li>
                            <li>Run external solver (svFSI, SimVascular, etc.)</li>
                        </ol>
                    </div>

                    <div class="admonition warning">
                        <p><strong>Mesh Quality:</strong> Poor quality tetrahedra (low minratio or mindihedral) can cause
                        solver convergence issues. Always check mesh quality metrics before running simulations.</p>
                    </div>

                    <div class="admonition note">
                        <p><strong>Boundary Layers:</strong> Essential for accurate wall shear stress calculation. The first
                        layer thickness should be sized to achieve y+ ≈ 1 for wall-resolved simulations.</p>
                    </div>

                    <h3>File Formats</h3>
                    <ul>
                        <li><strong>VTU:</strong> Unstructured grid volume meshes</li>
                        <li><strong>VTP:</strong> PolyData surface meshes</li>
                        <li><strong>XML:</strong> svFSI solver configuration</li>
                        <li><strong>JSON:</strong> 1D solver parameters</li>
                    </ul>
                </section>

                <!-- See Also Section -->
                <section class="api-section">
                    <h2>See Also</h2>
                    <ul>
                        <li><a href="tree.html"><code>svv.tree.Tree</code></a> - Vascular tree generation</li>
                        <li><a href="forest.html"><code>svv.forest.Forest</code></a> - Multi-network structures</li>
                        <!--<li><code>svv.simulation.GeneralMesh</code> - Mesh management class</li>
                        <li><code>svv.simulation.FluidEquation</code> - Fluid physics configuration</li>
                        <li><code>svv.simulation.BoundaryLayer</code> - Boundary layer generation</li> -->
                    </ul>
                </section>
            </main>

            <!-- Right TOC -->
            <aside class="api-toc-sidebar">
                <div class="sidebar-section">
                    <h4 class="sidebar-title">On This Page</h4>
                    <nav id="local-toc" class="api-local-toc">
                        <!-- Auto-populated by JavaScript -->
                    </nav>
                </div>
            </aside>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 SimVascular, Stanford University, The Regents of the University of California, and others –
            <a href="https://opensource.org/license/BSD-3-Clause">BSD 3-Clause License</a><br></p>
        </div>
    </footer>

    <!-- Additional styles for this page -->
    <style>
        .api-class-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--clr-primary-400);
        }

        .api-class-header h1 {
            margin: 0;
            font-family: Consolas, monospace;
            color: var(--clr-primary-700);
        }

        .api-badges {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .api-class-description {
            background: var(--clr-grey-100);
            border-left: 4px solid var(--clr-primary-400);
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 2rem;
        }

        .api-method {
            background: var(--clr-surface);
            border: 1px solid var(--clr-grey-300);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .api-method-signature {
            background: var(--clr-grey-100);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-family: Consolas, monospace;
            margin-bottom: 0.75rem;
            overflow-x: auto;
        }

        .api-method-params h4 {
            color: var(--clr-primary-700);
            font-size: 0.9rem;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
    </style>

    <!-- Load Scripts -->
    <script defer src="../script.js"></script>
    <script defer src="script_api.js"></script>
</body>
</html>
